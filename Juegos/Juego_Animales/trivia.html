<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trivia de Animales para Ni√±os</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Chewy&display=swap');

    body {
      font-family: 'Chewy', cursive;
      background: linear-gradient(180deg, #ffe6b3, #ffcc80);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      background-color: #fff8e1;
      border-radius: 20px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
      padding: 30px;
      max-width: 900px;
    }

    h1 {
      text-align: center;
      color: #ff9800;
      font-size: 2.5rem;
      margin-bottom: 20px;
      text-shadow: 2px 2px #fff;
    }

    .animal-art {
      font-size: 90px;
      text-align: center;
      margin-bottom: 20px;
    }

    .question {
      font-size: 1.5rem;
      text-align: center;
      color: #5d4037;
    }

    .choices button {
      font-size: 1.2rem;
      width: 100%;
      margin: 10px 0;
      border-radius: 15px;
      border: none;
      background-color: #ffe0b2;
      color: #5d4037;
      transition: 0.3s;
    }

    .choices button:hover {
      background-color: #ffcc80;
      transform: scale(1.05);
    }

    .choices .correct {
      background-color: #a5d6a7 !important;
      color: #2e7d32 !important;
    }

    .choices .wrong {
      background-color: #ef9a9a !important;
      color: #b71c1c !important;
    }

    #feedback {
      text-align: center;
      font-size: 1.2rem;
      margin-top: 10px;
      color: #6d4c41;
      min-height: 30px;
    }

    .progress-bar {
      background-color: #ffb74d !important;
    }

    .results {
      display: none;
      text-align: center;
      font-size: 1.5rem;
      color: #5d4037;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container text-center">
    <h1>üêæ Trivia de Animales üêæ</h1>

    <div id="game">
      <div class="animal-art" id="animalArt">ü¶Å</div>
      <p class="question" id="question">¬øQu√© animal es este?</p>

      <div class="choices" id="choices"></div>

      <div class="mt-3">
        <div class="progress" style="height: 20px;">
          <div class="progress-bar" id="progBar" style="width: 0%"></div>
        </div>
      </div>

      <div id="feedback"></div>
      <div class="results" id="results">
        <h3>üéâ Resultado üéâ</h3>
        <p id="finalScore"></p>
        <p id="finalText"></p>
        <div class="d-flex justify-content-center gap-3 mt-3">
          <button class="btn btn-warning text-white fs-5" id="restart">Jugar otra vez</button>
          <button class="btn btn-secondary text-white fs-5" id="exitBtn">Salir</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Preparado para sonidos (archivos en la misma carpeta que trivia.html) -->
  <audio id="soundCorrect" src="match.mp3" preload="auto"></audio>
  <!-- si no existe wrong.mp3, usamos match.mp3 como fallback -->
  <audio id="soundWrong" src="wrong.mp3" preload="auto" onerror="this.src='match.mp3'"></audio>
  <audio id="soundEnd" src="win.mp3" preload="auto"></audio>

  <script>
    // Protecci√≥n: permitir solo alumnos logueados (no docentes)
    (function(){
      const usuario = localStorage.getItem('usuario');
      const docente = localStorage.getItem('docente');
      if (!usuario) {
        // Redirigir al login de alumnos si no hay usuario
        window.location.href = '/Jardin/Essencial/login.html';
        return;
      }
      // Si hay una marca de docente en localStorage pero NO coincide con el usuario
      // actual, puede ser una clave stale de pruebas anteriores: la ignoramos y la borramos.
      if (docente && docente !== usuario) {
        console.warn('Clave "docente" encontrada pero no coincide con el usuario actual. Limpiando clave stale.');
        localStorage.removeItem('docente');
        return;
      }
      // Si la marca de docente coincide con el usuario actual, entonces es un docente y no
      // debe jugar esta trivia.
      if (docente && docente === usuario) {
        alert('Esta trivia est√° destinada a alumnos. Volviendo al men√∫ principal.');
        window.location.href = '/Jardin/Essencial/Principal.html';
        return;
      }
    })();

    const QUESTIONS = [
      {q: '¬øQu√© animal ruge y es el rey de la selva?', emoji: 'ü¶Å', choices:['Tigre','Le√≥n','Lobo','Elefante'], a:1},
      {q: '¬øQu√© animal tiene una trompa muy larga?', emoji: 'üêò', choices:['Elefante','Hipop√≥tamo','Rinoceronte','Camello'], a:0},
      {q: '¬øQu√© animal tiene el cuello m√°s largo?', emoji: 'ü¶í', choices:['Jirafa','Cebra','Llama','Caballo'], a:0},
      {q: '¬øQu√© animal tiene rayas negras y blancas?', emoji: 'ü¶ì', choices:['Cebra','Tigre','Gato','Perro'], a:0},
      {q: '¬øQu√© animal tiene una gran melena y vive en la sabana?', emoji: 'ü¶Å', choices:['Le√≥n','Oso','Camello','Canguro'], a:0},
      {q: '¬øQu√© animal vive en el agua y tiene ocho brazos?', emoji: 'üêô', choices:['Pulpo','Calamar','Pez','Cangrejo'], a:0}
    ];

    let index = 0, score = 0;

    const animalArt = document.getElementById('animalArt');
    const questionEl = document.getElementById('question');
    const choicesEl = document.getElementById('choices');
    const feedback = document.getElementById('feedback');
    const results = document.getElementById('results');
    const finalScore = document.getElementById('finalScore');
    const finalText = document.getElementById('finalText');
    const restart = document.getElementById('restart');
    const progBar = document.getElementById('progBar');

    // Sonidos
    const soundCorrect = document.getElementById('soundCorrect');
    const soundWrong = document.getElementById('soundWrong');
    const soundEnd = document.getElementById('soundEnd');

    function loadQuestion() {
      if(index >= QUESTIONS.length) return endGame();
      const q = QUESTIONS[index];
      animalArt.textContent = q.emoji;
      questionEl.textContent = q.q;
      choicesEl.innerHTML = '';
      q.choices.forEach((choice, i) => {
        const btn = document.createElement('button');
        btn.className = 'btn btn-light';
        btn.textContent = choice;
        btn.onclick = () => selectChoice(i, q.a, btn);
        choicesEl.appendChild(btn);
      });
      feedback.textContent = '';
    }

    function selectChoice(i, correct, btn) {
      const buttons = choicesEl.querySelectorAll('button');
      buttons.forEach(b => b.disabled = true);
      if(i === correct) {
        btn.classList.add('correct');
        feedback.textContent = '¬°Muy bien! ü•≥';
        score++;
        try { soundCorrect.play().catch(()=>{}); } catch(e) {}
      } else {
        btn.classList.add('wrong');
        buttons[correct].classList.add('correct');
        feedback.textContent = 'Ups... intenta la pr√≥xima. üòÖ';
        try { soundWrong.play().catch(()=>{}); } catch(e) {}
      }
      setTimeout(nextQuestion, 1000);
    }

    function nextQuestion() {
      index++;
      progBar.style.width = (index / QUESTIONS.length * 100) + '%';
      if(index < QUESTIONS.length) loadQuestion();
      else endGame();
    }

    function endGame() {
      results.style.display = 'block';
      questionEl.style.display = 'none';
      choicesEl.style.display = 'none';
      animalArt.style.display = 'none';
      feedback.textContent = '';
      finalScore.textContent = `Tu puntaje: ${score} / ${QUESTIONS.length}`;
      finalText.textContent = score === QUESTIONS.length ? '¬°Excelente! üåü' : '¬°Muy bien hecho! üêæ';

      // Enviar puntos al servidor en segundo plano (si hay usuario), sin alertas.
      const nombreJugador = localStorage.getItem('usuario');
      if (nombreJugador) {
        fetch('/Jardin/Essencial/Excepcional/sumar_puntos.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({ nombre: nombreJugador, puntos: score })
        })
        .then(async r => {
          const text = await r.text();
          try {
            return JSON.parse(text);
          } catch (err) {
            console.error('Respuesta no JSON del servidor:', text);
            throw new Error('invalid_json');
          }
        })
        .then(data => {
          if (data && data.puntos != null) {
            localStorage.setItem('puntos', data.puntos);
            console.log('Puntos actualizados en background:', data.puntos);
          } else {
            console.warn('No se recibi√≥ el total de puntos en la respuesta.');
          }
        })
        .catch(err => {
          console.error('Error enviando puntos en background:', err);
        })
        .finally(() => { try { soundEnd.play().catch(()=>{}); } catch(e) {} });
      } else {
        try { soundEnd.play().catch(()=>{}); } catch(e) {}
      }

      // Configurar bot√≥n Salir: env√≠a puntos (si no se enviaron a√∫n) y vuelve al men√∫ principal.
      const exitBtn = document.getElementById('exitBtn');
      if (exitBtn) {
        exitBtn.onclick = async () => {
          // Intentar enviar de nuevo antes de salir (no mostrar mensajes)
          if (nombreJugador) {
            try {
              const r = await fetch('/Jardin/Essencial/Excepcional/sumar_puntos.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: new URLSearchParams({ nombre: nombreJugador, puntos: score })
              });
              const text = await r.text();
              try { const data = JSON.parse(text); if (data && data.puntos != null) localStorage.setItem('puntos', data.puntos); } catch(e){/* ignore */}
            } catch(e) { console.error('Error enviando puntos al salir:', e); }
          }
          window.location.href = '/Jardin/Essencial/Principal.html';
        };
      }
    }

    restart.onclick = () => location.reload();

    loadQuestion();
  </script>
</body>
</html>
