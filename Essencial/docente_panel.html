<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel Docente</title>
  <link rel="stylesheet" href="/Jardin/Static/bootstrap-5.3.7-dist/bootstrap-5.3.7-dist/css/bootstrap.min.css">

  <style>
    :root { --sidebar-width: 220px; }
    body {
      background-color: #f5f5f5;
      overflow-x: hidden;
    }

 
    #sidebar {
      display: none;
      background-color: #198754;
      color: white;
      padding-top: 20px;
    }

    #sidebar a {
      color: white;
      text-decoration: none;
      display: block;
      padding: 10px 20px;
    }

    #sidebar a:hover {
      background-color: #157347;
    }

    main {
      margin-left: 0;
      padding: 16px;
    }

    
    @media (min-width: 992px) {
      #sidebar {
        display: block;
        height: 100vh;
        position: fixed;
        top: 0;
        left: 0;
        width: var(--sidebar-width);
      }
      main {
        margin-left: calc(var(--sidebar-width) + 16px);
        padding: 20px;
      }
    }

    
    table th {
      background-color: #198754;
      color: white;
    }

  
    #tablaPuntosMobile {
      display: grid;
      grid-template-columns: 1fr;
      gap: 0.75rem;
    }

    @media (min-width: 576px) {
   
      #tablaPuntosMobile {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (min-width: 768px) {
      
      #tablaPuntosMobile {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    #tablaPuntosMobile .card {
      margin: 0;
    }
    #tablaPuntosMobile .card .card-body {
      padding: 10px;
    }

    
    .offcanvas {
      z-index: 1045;
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <!-- Top bar for small screens with offcanvas toggle -->
      <div class="col-12 d-md-none bg-success text-white p-2 d-flex justify-content-between align-items-center">
        <div class="fw-bold">Panel del Docente</div>
        <button class="btn btn-light btn-sm" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasSidebar" aria-controls="offcanvasSidebar">
          Men칰
        </button>
      </div>

      <!-- Offcanvas sidebar for small screens -->
      <div class="offcanvas offcanvas-start bg-success text-white" tabindex="-1" id="offcanvasSidebar" aria-labelledby="offcanvasSidebarLabel">
        <div class="offcanvas-header">
          <h5 class="offcanvas-title text-white" id="offcanvasSidebarLabel">Panel del Docente</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
          <p class="fw-bold" id="nombreDocenteOff"></p>
          <hr class="border-light">
          <a href="canciones.html" class="d-block text-white mb-2">游꿧 Canciones</a>
          <a href="#" id="cerrarSesionOff" class="d-block text-white">游뛁 Cerrar sesi칩n</a>
        </div>
      </div>

      <!-- Sidebar for md+ -->
      <nav id="sidebar" class="col-md-3 col-lg-2 d-none d-md-block sidebar">
        <h4 class="text-center mb-4">Panel del Docente</h4>
        <p class="text-center fw-bold" id="nombreDocente"></p>
        <hr>
        <a href="canciones.html">游꿧 Canciones</a>
        <a href="#" id="cerrarSesion">游뛁 Cerrar sesi칩n</a>
      </nav>

      <!-- CONTENIDO PRINCIPAL -->
      <main class="col-12 col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4">
        <div class="container-fluid">
          <h2 class="mb-4 text-success text-center">Tabla de puntos de los alumnos</h2>

          <div class="table-responsive d-none d-md-block">
            <table id="tablaPuntos" class="table table-striped table-bordered text-center align-middle">
              <thead>
                <tr>
                  <th>Nombre del alumno</th>
                  <th>Puntos</th>
                  <th>칔ltima actualizaci칩n</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                <tr><td colspan="4">Cargando datos...</td></tr>
              </tbody>
            </table>
          </div>

          <!-- Mobile: cards view -->
          <div id="tablaPuntosMobile" class="d-block d-md-none">
            <!-- cards se inyectan aqu칤 -->
            <p class="text-center text-muted">Cargando datos...</p>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script src="/Jardin/Static/bootstrap-5.3.7-dist/bootstrap-5.3.7-dist/js/bootstrap.bundle.min.js"></script>

  
  <script>
    const docente = localStorage.getItem('docente');
    if (!docente) {
      alert('Acceso restringido. Inici치 sesi칩n primero.');
      window.location.href = 'login_docentes.html';
    } else {
      const nombreDesktop = document.getElementById('nombreDocente');
      const nombreOff = document.getElementById('nombreDocenteOff');
      if (nombreDesktop) nombreDesktop.textContent = docente;
      if (nombreOff) nombreOff.textContent = docente;
    }

    function cerrarSesion() {
      localStorage.removeItem('docente');
      localStorage.removeItem('registro_id');
      window.location.href = 'login_docentes.html';
    }

    const btnCerrar = document.getElementById('cerrarSesion');
    if (btnCerrar) btnCerrar.addEventListener('click', cerrarSesion);
    const btnCerrarOff = document.getElementById('cerrarSesionOff');
    if (btnCerrarOff) btnCerrarOff.addEventListener('click', cerrarSesion);
  </script>

  
  <script>
  async function cargarPuntos() {
    try {
      const respuesta = await fetch("Excepcional/obtener_puntos.php");
      const datos = await respuesta.json();

      
      const tablaBody = document.querySelector("#tablaPuntos tbody");
      if (tablaBody) {
        tablaBody.innerHTML = "";
        if (!Array.isArray(datos) || datos.length === 0) {
          tablaBody.innerHTML = '<tr><td colspan="4">No hay registros a칰n.</td></tr>';
        } else {
          datos.forEach(fila => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${fila.nombre}</td>
              <td id="puntos-${fila.id}">${fila.puntos}</td>
              <td>${fila.ultima_actualizacion}</td>
              <td>
                <button class="btn btn-sm btn-success me-1" onclick="actualizarPuntos(${fila.id}, 1)">+1</button>
                <button class="btn btn-sm btn-danger" onclick="actualizarPuntos(${fila.id}, -1)">-1</button>
              </td>
            `;
            tablaBody.appendChild(tr);
          });
        }
      }

      
      const mobileContainer = document.getElementById('tablaPuntosMobile');
      if (mobileContainer) {
        mobileContainer.innerHTML = '';
        if (!Array.isArray(datos) || datos.length === 0) {
          mobileContainer.innerHTML = '<p class="text-center text-muted">No hay registros a칰n.</p>';
        } else {
          datos.forEach(fila => {
            const card = document.createElement('div');
            card.className = 'card mb-2 shadow-sm';
            card.innerHTML = `
              <div class="card-body">
                <h5 class="card-title mb-1">${fila.nombre}</h5>
                <p class="mb-1"><strong>Puntos:</strong> <span id="mobile-puntos-${fila.id}">${fila.puntos}</span></p>
                <p class="mb-2 text-muted small">칔ltima: ${fila.ultima_actualizacion}</p>
                <div class="d-flex gap-2">
                  <button class="btn btn-sm btn-success flex-fill" onclick="actualizarPuntos(${fila.id}, 1)">+1</button>
                  <button class="btn btn-sm btn-danger flex-fill" onclick="actualizarPuntos(${fila.id}, -1)">-1</button>
                </div>
              </div>
            `;
            mobileContainer.appendChild(card);
          });
        }
      }

    } catch (error) {
      console.error("Error al cargar puntos:", error);
      const tablaBody = document.querySelector("#tablaPuntos tbody");
      if (tablaBody) tablaBody.innerHTML = '<tr><td colspan="4">Error al cargar datos</td></tr>';
      const mobileContainer = document.getElementById('tablaPuntosMobile');
      if (mobileContainer) mobileContainer.innerHTML = '<p class="text-center text-danger">Error al cargar datos</p>';
    }
  }

  async function actualizarPuntos(id, cambio) {
    try {
      const formData = new FormData();
      formData.append("usuario_id", id);
      formData.append("puntos", cambio);

      const respuesta = await fetch("Excepcional/actualizar_puntos.php", {
        method: "POST",
        body: formData
      });

      const texto = await respuesta.text();
      console.log("Respuesta del servidor:", texto);

      
      await cargarPuntos();

    } catch (error) {
      console.error("Error al actualizar puntos:", error);
    }
  }

  
  document.addEventListener("DOMContentLoaded", () => {
    cargarPuntos();
    setInterval(cargarPuntos, 10000);
  });
  </script>

</body>
</html>
